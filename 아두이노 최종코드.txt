#include <TM1637Display.h>
#include <SoftwareSerial.h>
#include "Adafruit_Thermal.h"
#include <avr/pgmspace.h>

    //¼¼±×¸ÕÆ® ¼±¾ð
    #define CLK 9
    #define DIO 8
    TM1637Display display(CLK, DIO);

    //¿­Àü»ç ÇÁ¸°Æ® ¼±¾ð
    int printer_RX_Pin = 2;  
    int printer_TX_Pin = 3;  
    Adafruit_Thermal printer(printer_RX_Pin, printer_TX_Pin); 

    //ºí·çÅõ½º Ä¿³ØÆ® ¼±¾ð
    int blueTx=4;   //Tx (º¸³»´ÂÇÉ ¼³Á¤)at
    int blueRx=5;   //Rx (¹Þ´ÂÇÉ ¼³Á¤)
    SoftwareSerial mySerial(blueTx, blueRx);  

    int buttonPin = 10;
       
    void setup() {
        display.setBrightness(0x0f);        // ¹à±â ¼³Á¤
        Serial.begin(9600);
         mySerial.begin(38400); //ºí·çÅõ½º band rate
        pinMode(7, OUTPUT); 
        digitalWrite(7, LOW);
        pinMode(buttonPin, INPUT_PULLUP); // ¹öÆ° Pin
        printer.begin();
   }

//////////////////////////////////////////////////////////////////
   // ¼¼±×¸ÕÆ® ¼ýÀÚ Ãâ·Â ÇÔ¼ö
   void selectSegment(int val){
       char data[10];
       data[0] = 0b01001001;
       data[1] = display.encodeDigit(1);
       data[2] = display.encodeDigit(2);
       data[3] = display.encodeDigit(3);
       data[4] = display.encodeDigit(4);
       data[5] = display.encodeDigit(5);
       data[6] = display.encodeDigit(6);
       data[7] = display.encodeDigit(7);
       data[8] = display.encodeDigit(8);
       data[9] = display.encodeDigit(9);
    
    int cal = val;
    int one = cal%10;
    int two = (cal%100 - one)/10;
    int three = (cal%1000 - (two*10))/100;
    int four = (cal-(three*100)-(two*10)-(one))/1000;

     display.setSegments(data[one], 1, 0);
     display.setSegments(data[two], 1, 1);
     display.setSegments(data[three], 1, 2);
     display.setSegments(data[four], 1, 3);
   }
    ////////////////////////////////////////////////////////////
   //¿­Àü»ç ÇÁ¸°ÅÍ ­„·Â ÇÔ¼ö
   void printNumber(String reserve_num, String reserve_man, String reserve_time){
      printer.justify('C');
      printer.boldOn();
      printer.setSize('L');
      printer.println("ÇÁ¸°ÅÍ");
      printer.boldOff();
     
      
      printer.justify('C');
      printer.setSize('M');
      String num_str = "´ë±â¹øÈ£ : "+reserve_num +" ¹ø";
      String man_str = "´ë±âÀÎ¿ø : "+reserve_man +" ¸í";
      String time_str = "´ë±â½Ã°£ : "+reserve_time +" ºÐ";
      printer.println("´ë±â¹øÈ£ :  ¹ø");
      printer.println("´ë±âÀÎ¿ø : 05 ¸í");
      printer.println("¿¹»ó´ë±â ½Ã°£ : 03 ºÐ");
      printer.feed(1);
     /*
      printer.printBitmap(tempBMP_width, tempBMP_height, tempBMP_data);
      
      printer.feed(1);
      printer.printBitmap(QR_width, QR_height, QR_data);
     
      printer.feed(1);
    */  
      //QRÄÚµå ÇÁ¸°Æ® Å×½ºÅÍ 
    
      printer.sleep();
      printer.wake();       
      printer.setDefault(); 
      // ÇÁ¸°ÅÍ¸¦ ±âº» ¼¼ÆÃÀ¸·Î ´Ù½Ã ¼¼ÆÃÇÕ´Ï´Ù.
   }
////////////////////////////////////////////////////////////////// 
   void loop() {
        selectSegment(1234);// ¼¼±×¸ÕÆ® º¯¼ö ¼±¾ð
   
        if(digitalRead(buttonPin)){ //¹öÆ° ´­·¶À»½Ã
          printNumber("1","1","1"); //@´ë±â¹øÈ£, @´ë±âÀÎ¿ø , @´ë±â½Ã°£ ÀÔ·Â½Ã ÇÁ¸°ÅÍ Ãâ·Â 
        }else if (mySerial.available()) {       
          if(mySerial.read() ==1){
            printNumber("1","1","1"); //@´ë±â¹øÈ£, @´ë±âÀÎ¿ø , @´ë±â½Ã°£ ÀÔ·Â½Ã ÇÁ¸°ÅÍ Ãâ·Â 
          }
        }
      delay(200);
   }